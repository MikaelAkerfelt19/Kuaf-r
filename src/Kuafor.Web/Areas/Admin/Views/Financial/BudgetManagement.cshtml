@model List<Kuafor.Web.Models.Entities.Budget>
@{
    ViewData["Title"] = "Bütçe Yönetimi";
    Layout = "_Layout.Admin";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Bütçe Yönetimi</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#createBudgetModal">
                            <i class="fas fa-plus"></i> Yeni Bütçe Oluştur
                        </button>
                        <a href="@Url.Action("Index")" class="btn btn-secondary">Geri Dön</a>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Budget Overview -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h4 id="totalBudget">₺0</h4>
                                    <p class="mb-0">Toplam Bütçe</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h4 id="usedBudget">₺0</h4>
                                    <p class="mb-0">Kullanılan Bütçe</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h4 id="remainingBudget">₺0</h4>
                                    <p class="mb-0">Kalan Bütçe</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Budget List -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Bütçe Adı</th>
                                    <th>Dönem</th>
                                    <th>Toplam Bütçe</th>
                                    <th>Kullanılan</th>
                                    <th>Kalan</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Sample data - replace with actual model data -->
                                <tr>
                                    <td>2024 Yıllık Bütçe</td>
                                    <td>2024</td>
                                    <td>₺120,000</td>
                                    <td>₺85,000</td>
                                    <td>₺35,000</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-success" style="width: 70%"></div>
                                        </div>
                                        <small>70% Kullanıldı</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info" onclick="viewBudgetDetails(1)">Detay</button>
                                        <button class="btn btn-sm btn-warning" onclick="editBudget(1)">Düzenle</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteBudget(1)">Sil</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Aralık 2024 Aylık</td>
                                    <td>Aralık 2024</td>
                                    <td>₺15,000</td>
                                    <td>₺12,500</td>
                                    <td>₺2,500</td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" style="width: 83%"></div>
                                        </div>
                                        <small>83% Kullanıldı</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info" onclick="viewBudgetDetails(2)">Detay</button>
                                        <button class="btn btn-sm btn-warning" onclick="editBudget(2)">Düzenle</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteBudget(2)">Sil</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Budget Categories Chart -->
                    <div class="row mt-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Kategori Bazında Bütçe Dağılımı</h4>
                                </div>
                                <div class="card-body">
                                    <canvas id="budgetCategoryChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h4>Bütçe Kullanım Oranı</h4>
                                </div>
                                <div class="card-body">
                                    <canvas id="budgetUsageChart" width="400" height="400"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Budget Modal -->
<div class="modal fade" id="createBudgetModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Yeni Bütçe Oluştur</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form id="budgetForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Bütçe Adı</label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Dönem Türü</label>
                                <select name="periodType" class="form-control" required>
                                    <option value="Monthly">Aylık</option>
                                    <option value="Quarterly">Üç Aylık</option>
                                    <option value="Yearly">Yıllık</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Başlangıç Tarihi</label>
                                <input type="date" name="startDate" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Bitiş Tarihi</label>
                                <input type="date" name="endDate" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Açıklama</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <!-- Budget Items -->
                    <h5>Bütçe Kalemleri</h5>
                    <div id="budgetItems">
                        <div class="budget-item-row">
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" name="budgetItems[0].category" class="form-control" placeholder="Kategori" required>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" name="budgetItems[0].budgetAmount" class="form-control" placeholder="Bütçe" step="0.01" required>
                                </div>
                                <div class="col-md-4">
                                    <input type="text" name="budgetItems[0].description" class="form-control" placeholder="Açıklama">
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeBudgetItem(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-success btn-sm mt-2" onclick="addBudgetItem()">
                        <i class="fas fa-plus"></i> Kalem Ekle
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Oluştur</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let budgetItemIndex = 1;

$(document).ready(function() {
    loadBudgetCharts();
});

function addBudgetItem() {
    const html = `
        <div class="budget-item-row mt-2">
            <div class="row">
                <div class="col-md-4">
                    <input type="text" name="budgetItems[${budgetItemIndex}].category" class="form-control" placeholder="Kategori" required>
                </div>
                <div class="col-md-3">
                    <input type="number" name="budgetItems[${budgetItemIndex}].budgetAmount" class="form-control" placeholder="Bütçe" step="0.01" required>
                </div>
                <div class="col-md-4">
                    <input type="text" name="budgetItems[${budgetItemIndex}].description" class="form-control" placeholder="Açıklama">
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeBudgetItem(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    $('#budgetItems').append(html);
    budgetItemIndex++;
}

function removeBudgetItem(button) {
    $(button).closest('.budget-item-row').remove();
}

function loadBudgetCharts() {
    // Budget Category Chart
    const categoryCtx = document.getElementById('budgetCategoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'bar',
        data: {
            labels: ['Malzeme', 'Personel', 'Kira', 'Utilities', 'Pazarlama'],
            datasets: [{
                label: 'Bütçe',
                data: [25000, 40000, 15000, 8000, 12000],
                backgroundColor: 'rgba(54, 162, 235, 0.6)'
            }, {
                label: 'Kullanılan',
                data: [18000, 35000, 15000, 6500, 8000],
                backgroundColor: 'rgba(255, 99, 132, 0.6)'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₺' + value.toLocaleString('tr-TR');
                        }
                    }
                }
            }
        }
    });

    // Budget Usage Chart
    const usageCtx = document.getElementById('budgetUsageChart').getContext('2d');
    new Chart(usageCtx, {
        type: 'doughnut',
        data: {
            labels: ['Kullanılan', 'Kalan'],
            datasets: [{
                data: [85000, 35000],
                backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

$('#budgetForm').on('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('@Url.Action("CreateBudget")', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#createBudgetModal').modal('hide');
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
    });
});

function viewBudgetDetails(budgetId) {
    // Open budget details modal
    alert('Bütçe detayları - ID: ' + budgetId);
}

function editBudget(budgetId) {
    // Open edit budget modal
    alert('Bütçe düzenle - ID: ' + budgetId);
}

function deleteBudget(budgetId) {
    if (confirm('Bu bütçeyi silmek istediğinizden emin misiniz?')) {
        fetch(`/Admin/Financial/delete-budget/${budgetId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Bütçe başarıyla silindi!');
                location.reload(); // Sayfayı yenile
            } else {
                alert('Hata: ' + (data.message || 'Bütçe silinemedi'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Bütçe silinirken bir hata oluştu');
        });
    }
}
</script>
